# The Glympse Adapter

- [Overview](#overview)
- [Client Mode](#client-mode)
- [Host Mode](#host-mode)
- [Examples](#examples)
- [Adapter Messages/Events](#adapter-messages/events)
- [Message/Event flow](#message/event-flow)
- [Adapter Endpoints](#adapter-endpoints)
- [Available modules](#available-modules)
- [Installation](#installation)
- [Glympse Adapter Roadmap](#glympse-adapter-roadmap)
- [Project Notes](#project-notes)
- [Release a new version](#release-a-new-version)

## Overview

The Glympse Adapter (GA) is a portable component that allows Javascript-based
applications to interface with the Glympse platform. This interface can be made
directly with client applications wishing to utilize additional components like the
Glympse viewer, or indirectly via an iframe interface in a pure data-only format.

The basic structure of the GA in action can be seen below:

![Glympse Adapter Overview](img/overview.png)

The GA automates many of the tasks involved with instantiating the Glympse viewer,
interfacing with the Glympse Platform API (from generating user accounts to requesting
data for a particular Glympse/Cards-based invite code), the Glympse Viewer API (adding/
removing invites, changing map settings, adjusting UI layouts, etc.), to invoking an
iframe-based view of a remote GA-enabled application, as shown below:

![Remote Adapter Integration](img/embed-scenario.png)

In addition, the API bridge provided by the GA maintains a mostly equivalent adaption
of the Glympse viewer API, save for some differences in event handler registration and
callback signatures. These (and all, really) will be described in detail. By default,
the exposed set of endpoints are those of the core Glympse Viewer API. Apps can also
extend/override the GA endpoints with their own methods, which are published to GA
consumers during setup.



## Client Mode
Below descibes how to utilize the GA in "client-mode", where full access is available
to all Viewer components, data structures, and many customization options. However, it
also requires more care in getting going, and maintaining a clean separation from the
Glympse Viewer, which will now be partially affected by the global namespace and
default styling options.

### Usage

The architecture of the GA running in client-mode is shown below:

![Glympse Adapter Client Mode](img/client-detail.png)

GA usage is straight-forward, but does have a dependency on a recent version of
[jQuery]. jQuery aside, all that is needed is to include the built
`GlympseAdapter` in your page, along with a bit of initialization and configuration
to get the adapter up and running:

```html
<script type="text/javascript" src="glympse-adapter-CURRENT_VERSION.min.js"></script>
```

Alternatively, the GA is available as a [Bower] package to include with your project
if using [RequireJS] via `bower install glympse-adapter --save`. If using the Bower
package, there is no need to include it as an external reference.

Initialization, including inserting the viewer into your page, should be done after
the page onLoad event has fired:

```javascript
$(window).ready(function()
{
	...
	... other init code
	...

	// Set up the adapter

	/* Global namespace */
	var adapter = new glympse.GlympseAdapter(adapter_handler_instance, cfg);

	/* AMD module format */
	//var GlympseAdapter = require('glympse-adapter/GlympseAdapter');
	//var adapter = new GlympseAdapter(adapter_handler_instance, cfg);

	adapter.client($('#div_viewer_container'));   // Note jQuery object reference
});
```

A couple of things to note here:
- `adapter_handler_instance` is a class instance to handle events and messages
  generated by the GA (described below).
- `cfg` is a simple Javascript object that defined both adapter and Glympse Viewer
  configuration (described below).
- `div_viewer_container` is the id of an HTML `div` element that already exists in
  the local DOM. The Glympse viewer will be inserted into this element when it is
  fully loaded.

For the `viewer_handler_reference` class, it must provide a public method with a
signature of `notify(idMessage, messageData)`. The `idMessage` parameter is a string
that will be one of the values as defined in the `glympse.GlympseAdapterDefines.MSG`
object. `messageData` can be a number of different types, depending on the value of
`idMessage`. Please refer to the *Adapter Messages/Events* section for specifics of
each message type.

GA client-mode  configuration format has two main components -- one for the Glympse
Viewer, and one for the adapter itself:

```javascript
var cfg =
{
	viewer: {
		.. normal viewer config settings ..
	}
	, adapter: {
		  card: *string*
		, t: *string*
		, pg: *string*
		, g: *string*
		, twt: *string*
		, hideEvents: *bool*
		, hideUpdates: *bool*
		, initialize: *function*
		, interfaces: { id0: callback0, ..., idN: callbackN }
		, apiKey: *string*|null|undefined
		, sandbox: *bool*
		, svcGlympse: *string*
		, dbg: *bool*
		, appName: *string*
		, appVersion: *string*
		, loaderEnvironment: *string*
		, loaderPath: *string*
		, loaderVersion: *string*
		, avatar: {
			minSize: *number* //in pixels
			, maxSize: *number* //in pixels
		}
	}
};
```

- `viewer` configuration is the normal Glympse viewer configuration object, described
  elsewhere. It should be noted that a valid invite/group/Twitter handler/Twitter
  topic setting should be set for normal viewer initialization.
- `adapter` settings are as follows:
  - `hideEvents`: Don't send event-related messages back to the
  `viewer_handler_reference.notify()` method. Currently, this includes everything
  except the `StateUpdate` message.
  - `hideUpdates`: Don't send `StateUpdate` messages back to the
  `viewer_handler_reference.notify()` method.
  - `hostQueueMaxSize`: [int] Max events to hold for adapter connecting in host-mode. Options:
    - 0: disable host message queue
    - < 0: no limit *(default)*
    - \> 0: limit to first `val` events
  - `initialize`: Method to call when the adapter has successully synced with a host
  adapater via iframe interface. Can be null.
  - `interfaces`: Allows for local overrides/extensions of advertised Glympse viewer
  endpoints. More details can be found in *Custom Endpoints*. Can also be null,
  - `apiKey`: Specifies the Core API key to use. If not set, the adapter will run in
  anonymous mode, which will allow only for the viewing of Core API invites.
  - `sandbox`: Force usage of the sandbox environment for Cards/Glympses. Note that
  this setting, if set, will change some defaults of other params to fully align to
  the sandbox environment: `loaderEnvironment`, `svcEnRoute` and `svcGlympse`
  - `svcEnRoute`: Override the default Glympse EnRoute API environment. Default is
    `//api.enterprice.glympse.com/api/v1/`, or `//s-api.enterprice.glympse.com/api/v1/`, if `sandbox` is set.
  - `svcGlympse`: Override the default Glympse API environment. Default is
  `//api.glympse.com/v2/`, or `//api.sandbox.glympse.com/v2/`, if `sandbox` is set.
  - `dbg`: Enable debugging state. Defaults to `false`.
  - `card`, `t`, `g`, `twt`, `pg`: Standard Cards/Glympse invite types.
  - `loaderEnvironment`: Environment for the viewer's loader: "prod"|"sandbox".
  Automatically set based on _sandbox_ setting if this param is not specified.
  - `loaderVersion`: Version of the viewer's loader. Default is "stable".
  - `loaderPath`: Arbitrary URL to the loader (overrides `loaderEnvironment` and `loaderVersion`). Default is NULL.
  - `avatar` - configuration for Image processing for `core.setUserAvatar` API endpoint
    - `minSize`: Min size for avatar image scaling
    - `maxSize`: Max size for avatar image scaling
  - `appName` - Name of the hosting application
  - `appVersion` - Version of the hosting application
  - `demoDriversCount` - The number of drivers to return in `demoshuttle` group. Min=0 and Max=7.
  - `demoWaypoints` - The list of waypoints which should be returned for the demo org object. 
  The format is `[ { name: 'Stop #1', lat: 123, lng: -123 }, ... ]`. The last point is base org location.

### Custom Marker Configuration
For the `addMarkers(cfgMarkers)` API, the `cfgMarkers` object is of the following
format:

	cfgMarkers = { showInfo: true|false, markers: [ marker_0_cfg, marker_1_cfg, ..., marker_N_cfg ] };

Each marker configuration is of the following format:

```javascript
var marker_N_cfg = { //ext: { path: image_url, id: null, w: width, h: height  }	// do not use if using icon setting
				 icon: { id: icon_id_from_spritesheet } // for internal
				, lat: latitude
				, lng: longitude
				, info: text_to_display // use \n to force a line break
				, track: true|false     // include for map-centering
				, link: url_to_load_if_marker_clicked
				, style: {
					  fontFamily: available_font_family
					, color: CSS_color
					, fontSize: font_size
					, maxWidth: max_width_in_pixels (forcing word wrap)
					, background: null|CSS_color
					, textMargin: margin_in_pixels
					}
				};
```

### Custom Route Options
For the `addRoute(cfgRoute)` API, the following configuration object is used:

```javascript
var cfgRoute = { start: [ lat, lng ]
			   , end: [ lat, lng ]
			   , useNubs: true|false // Add nubs to the start/end points
			   , nubSize: 6          // Nub radius
			   , nubStroke: 0.1      // Nub stroke
			   , style: { strokeColor: 'rgba(255,0,0,0.8)' }
		   };
```

### Custom Endpoints
While not usuaully necessary, the GA allows for extending and/or overriding the
default set of endpoints exposed by the Adapter if you need to allow for additional
functionality. As noted above, the format for specifying custom endpoints is in the
adapter's `interfaces` configuration setting:

```javascript
var cfg =
{
	viewer: {
		.. normal viewer config settings ..
	}
	, adapter: {
		.. other adapter settings ..
		, interfaces: { id0: callback0, ..., idN: callbackN }
	}
};
```

The `interfaces` object is an optional collection of methods to be made available for
GA consumers, or to override existing Glympse viewer methods. Each item in the
collection is decribed in the following manner:

- `id`: The name of the interface to advertise to GA host-mode consumers upon initial
adapter setup.
- `callback`: The method to execute when called from the GA host-mode consumer.

For `id`, if the name is the same as one of the pre-defined endpoints (listed above),
the default implementation is replaced with this custom version. However, the default
is still available via the id with the same name, but with a `base_` prefix (i.e.
`base_getValue` to reach the Glympse viewer's implementation).

Almost any valid Javascript name can be used, save for the default public method names
of the GA. To be safe, prefix the name of your custom endpoints with a unique name
(i.e. "my" would work wonderfully).

For now, your customized endpoints should return some value directly, if expected by
the caller. The current version of the GA does not support deferred responses. In the
next version, a Promise-based return value will allow for async handling for delayed
results (i.e. Ajax-based calls).

And for reference, the test app pair of `index-test.html` and `test/app.js` show an
example custom endpoint of `customMethodExample`. This can be easily extended and/or
enhanced for your needs.


## Host Mode
Below descibes how to utilize the GA in "host-mode", with limited access to Viewer
components and data structures. It runs in an iframe-based environment, providing a
clean separation to the rest of the page in which it is embedded. That said, the
communication channel established with the View-Mode-based GA control is fairly robust
and can handle a number of data types (including such things as image data).

### Usage

The architecture of the GA running in host-mode is shown below:

![Glympse Adapter Host Mode](img/host-detail.png)

Host-Mode usage has been designed to replicate the Glympse Viewer and Cards APIs,
adding a bit of initialization and configuration to get the adapter up and running.
All that is needed is to include the built GlympseAdapter.js in your page:

```html
<script type="text/javascript" src="glympse-adapter-VERSION.min.js"></script>
```

As noted in the Client Mode section, the GA can also be used in an AMD module
environment via Bower. Same set-up semantics apply when using GA in host mode.

Initialization, including inserting the viewer into your page, should be done after
the page onLoad event has fired:

```javascript
$(window).ready(function()
{
	...
	... other init code
	...

	// Set up the adapter

	/* Global namespace */
	var adapter = new glympse.GlympseAdapter(adapter_handler_instance, cfg);

	/* AMD module format */
	//var GlympseAdapter = require('glympse-adapter/GlympseAdapter');
	//var adapter = new GlympseAdapter(adapter_handler_instance, cfg);

	var el = adapter.host({
		url: 'http://glympse.com/INVITE_CODE',
		initialize: clientInitialized,
		connect: clientConnected,
		events:
		{
			StateUpdate: stateUpdate,
			ViewerInit: viewerInit,
			ViewerReady: viewerReady
		},
		sandbox:
		{
			disabled: true
		}
	});

	$('#divSandbox').append(el);

	...
});
```

A couple of things to note here:
- `adapter_handler_instance` is a class instance to handle events and messages
  generated by the GA (described below).
- `cfg` is a simple Javascript object that defined both adapter and Glympse Viewer
  configuration (described below).
- The iframed viewer is created/returned, when calling the GA instance's `host()`
  method.

`host()` configuration options are as follows:

- `url`: The Glympse invite URL. Generally this is the same as what is shared when
  sending a normal Glympse.
  - `partnerid`: Your app's registered PartnerId given to you by your
  Glympse representative
- `initialize`: Callback to handle iframe loaded event. Note that the Glympse viewer is
  not yet ready at this point, only that the page has been successfully loaded.
- `connect`: Callback to handle when the loaded Glympse viewer has registered itself
  with your hosting adapter. It is still not ready for action.
- `events`: Additional events to be handled by the host app. Not all events need to
  be handled if they aren't going to be used. Format is
  `{ event_id0: callback_handler0, ..., event_idN: callback_handlerN`. See the
  Host Events section below for available events that can be handled.
- `sandbox`: Configuration of sandbox environment:
    - `popups` `(default: false)` - allow opening windows from sandbox env
    - `disabled` `(default: false)` - (_only for iframe adapter_) do not create actual sandbox on iframe to allow all actions from iframed app
                   (**Note:** this is glympse specific feature, see notes [below](#project-notes))

All API calls to the client-mode adapter return a Promise, allowing for async handling
of all results. These should be treated like any baseline [Promise/A+] system:

```javascript
adapter.map.getInviteProperty({ idProperty: GlympseAdapterDefines.STATE.Name }).then(function(data)
{
	console.log('Glympse invite sender's name: ' + data);
}
```

A more detailed description of all of the available Glympse viewer APIs is described
elsewhere in this document. Additionally, refer to `app/test-host/index-host.html` as
a reference for using all available APIs with the GA running in host-mode.


### Host Event support
Events generated by the hosted client-based GA application can be hooked during host
mode initialization. All of the named events can be mapped by providing a function
callback. If no callback is provided, no event will be generated.

#### Host-specific Events
A couple low-level events have been added to monitor the loading and initialization
steps during the course of loading an iframe'd Glympse Adapter-based viewer. Both
of these settings are specified in the passed `host(cfg)` API configuration (outlined
elsewhere). However, these events are generally not needed for most applications,
except to monitor initialization and loading progress.

- `Initialize`: Invoked whenever the iframe html has been loaded and registered with
  the host container. Callback format is: `callback(name)`. The passed `name`
  parameter in the callback is the id used interface with the client-hosted viewer.

- `Connect`: Sent once the hosted GA application has loaded and initialized
  its interfaces with the host container. Callback format is: `callback(options)`.
  The passed `options` parameter in the callback shows the features of the hosted
  iframe'd client:
  - `invitesCard`: *(string)* List of Card invites to load
  - `invitesGlympse`: *(string)* List of Glympse invites to load (*string*)
  - `id`: *(string)* Connected client app identifier (generally "glympse-adapter")
  (*string*)
  - `version`: *(string)* Connected client GA version (*string*)
  - `map`: *(array)* Available map-based APIs
  - `cards`: *(array)* Available Glympse card-based APIs
  - `ext`: *(array)* Available custom APIs
  - `core`: *(array)* Available Glympse ticket-based APIs
  - `app`: *(array)* Available well-known application APIs



#### Cards/Map/Custom Events
All of the GA-based event handlers are specified in the `events` section of the
`host(cfg)` configuration (as outlined above). The names of the handlers are identical
to the name of the Adapter event to be handled. For example, to handle the `ViewerInit`
and `ViewerReady` events, the `host()` config object would look like:

```javascript
var htmlElement = adapter.host(
	{ url: ...,
	  events: { ViewerInit: myViewerInit, ViewerReady: myViewerReady }
	}
);
```
If you do not specify a handler for a particular GA event, it will not be raised by GA.


## Examples
### Client-mode
An example of setting up a GA client-mode-based application can be found in
`app/src/test-client`. This test app demonstrates various GA actions when a
Glympse ticket/card invite is loaded.

This example should be used as a reference of how to invoke and interact with
the GA in client-mode.

### Host-mode
An example of setting up a GA host-mode-based application can be found in
`app/src/test-host`. This test app demonstrates how to hook into a
remote GA client-mode-based application and leverage interesting events that
are generated when a Glympse ticket/card invite is loaded. There are also
examples of how to directly query the client-mode application to retrieve
specific data.

However, some setup is required to alias the local machine to point to the
`app/src/test-client/index-client.html` application. To use the example out of the box
(on an OSX-based system):

- Open a shell in the synced root directory of this repo
  - `cd app`
  - `python -m SimpleHTTPServer 8000`
- In another shell:
  - `cd app`
  - `python -m SimpleHTTPServer 8080`
- In a browser, connect to: `http://localhost:8080/src/test-host/index-host.html`

If the above isn't feasible for you, make whatever settings necessary to point to the
`app/src/test-client` directory to another port/domain and edit the `app.urlClient`
setting in `app/src/test-host/index-host.html` (on or around line 42).

This example should be used as a reference of how to invoke and interact with the GA
in host-mode.

### Simultaneous Host/Client mode
In some scenarios, it is useful to have an app utilizing the GA in both
host and client modes. In such cases, multiple instances of the adapter need
to be created to support this scenario, as the adapter is currently locked
to a single mode once it is initialized.

A simple example that leverages the code from the above host and client
examples can be found in `app/src/test-host/client`. Check out `src/app.js`
as the reference for instantiating two GAs simultaneously.

As with the *Host mode* example, the same setup is required for running the
host-mode portion of the demo, changing the path to load:
`http://localhost:8080/src/test-host-client/index-host-client.html`


## Adapter Messages/Events

The following is a description of the various notification messages (or Events, if
using GA in host-mode) that are sent by the adapter (defined in the
`GlympseAdapterDefines.MSG` object):

- `AccountCreateStatus` / `{ status: bool }`: Indicates the account has been created or
  creation failed with `error` message and `status: false`
- `AccountLoginStatus` / `{ status: bool }`: `status: true` - Indicates the adapter successfully
  logged in. `status: false` - Error occurred, property `error` has additional info about it
- `AccountDeleteStatus` / `{ status: bool }`: `status: true` - Indicates the adapter successfully
  removed current credentials.
- `AdapterInit` / `{ isCard: bool, t: string }`: Indicates the adapter is beginning
  its loading sequence with the passed card invite or the specified Glympse invite
  (indicated via the `t` parameter)
- `AdapterReady` / `{ cards:[ invites ], glympses: [ invites ]}`: Specifies the
  adapter has resolved all Card and Glympse invites and will begin the process
  of loading the specified Glympse invites. It should be noted that the adapter
  may return a card that was not specified in the `AdapterInit` phase, and may
  have changed the initial Glympse invite code, or included additional Glympse
  invites. This is due to the adapter detecting a Card invite reference in the
  initial Glympse invite code, and aligning the viewer to the Card reference and
  it's child Glympse invites.
- `CreateRequestStatus` / `{ status: bool }`: Indicates the request was created or 
  creation failed with `error` message and `status: false`
- `CardInit` / `card_invite`: Fired just before an attempt is made to load the
  Card invite.
- `CardReady` / `card_invite`: Fired once the given Card invite has completed
  loading, regardless of success. Check the passed card's instance given upon
  the `CardsInitEnd` event.
- `CardsInitEnd` / `[ card_instance0, ..., card_instanceN ]`: Sent once all
  cards have been loaded. The passed array are a set of Card.js class instances
  that can be check for various properties/state. Please reference the `Card.js`
  Data Model section for available APIs.
  - Note that in GA Host mode, Card instances are not passed
- `CardsInitStart` / `[ card_invite0, ..., card_inviteN ]`: Notification sent
  just before Card data is loaded. The passed array is a list of the Card invite
  codes that will be loaded.
- `CardAdded` / `card`: Notification sent when new card is added and loaded.
- `CardRemoved` / `card`: Notification sent when card is removed.
- `CardUpdated`: Notification sent when card is updated (e.g. members' list changed).
  Event model:
  - `card: Card`: model of changed card
  - `action: string`: possible actions:
    - `member_added`
    - `member_removed`
    - `invite_added`
    - `invite_removed`
    - `member_started_sharing`
    - `member_stopped_sharing`
    - other actions described in the [spec](https://developer.glympse.com/docs/core/api/reference/cards/id/activity/get).
  - `member: Member`: model of card member (only for `member_*` events)
  - `invite: string`: invite code (only for invite's related events)
  - `data: Object`: not parsed response for all other actions
  
- `CardsJoinRequestStatus`: Indicates that Card join request has been created or
  creation failed with `response.error` message and `status: false`
- `CardsJoinRequestCancelStatus`: Indicates that Card join request has been cancelled or
  cancelling failed with `response.error` message and `status: false`
- `CardActivityStatus`: Returns the list of card activities for the requested period
- `CardsActiveJoinRequestsStatus`: Returns the list of active join card requests in `response` property
- `CardRemoveMemberStatus`: Indicates that Card member was removed or removing failed with `response.error` message and `status: false`
- `CardsLocationRequestStatus`: Indicates that location request was created or creation failed with `response.error` message and `status: false`
- `DataUpdate` / `{ id: glympse_invite_code, owner: glympse_user_account_id, card: card_id, data: [ property_0, ..., propertyM ] }`:
  Event passed from the Glympse API for a given Glympse invite code, for unknown/custom
  properties found in the Glympse's data stream. The format of property elements
  in the array are the same format as specified in the Glympse Data stream model:
  - `t`: Time property was generated
  - `n`: Property id
  - `v`: Property value (may be default type, or a custom Object with additional
  members)
- `EtaInfo`: Generates when ETA info was fetched in response to `getEtaInfo` request to the `core` endpoint, 
  with information the loaded ETAs. The order in array the same as in request args.
- `GroupLoaded`: Generated after an `addGroup` command is sent to the `core` endpoint, with information
  about the just-loaded Glympse public group. For normal responses, the `args` payload will look something
  like:
  ```
  {
    "status": true,
    "response": {
      "type": "group",
      "id": 119,
      "events": 1,
      "members": [
        {
          "id": "DNA7-4HDZ-03WH0",
          "invite": "demobot0"
        }
      ],
      "public": true,
      "name": "DemoShuttle"
    },
    "time": 1499192505285,
    "group": "demoshuttle",
    "invitesAdded": [
      "demobot0"
    ],
    "invitesRemoved": [],
    "invitesSwapped": []
  }
  ```
- `GroupStatus`: Seen periodically after a public group has been added to the adapter. This event
  will contain updates to the group after initial load. Main usage will be in examining the contents
  of the `invitesAdded`, `invitesRemoved`, and `invitesSwapped` arrays, which will be the updates since
  initial load. Note that this event data will be identical to the initial `GroupLoaded` event for the
  first `GroupResponse` event seen. See `GroupLoaded` for expected data format.
- `OrgObjects`: Generated after an `getOrgObjects` command is sent to the `core` endpoint, with information
  about the loaded org objects. For normal responses, the `args` payload will look something like:
  ```
  {
    "status": true,
    "response": [
      {
        "hierarchy": [],
        "org_id": 603,
        "last_modified_by": 83867,
        "prop": true,
        "last_modified": 1498545443327,
        "created_time": 1498545401259,
        "creator_agent_id": 83867,
        "_id": 6,
        "type": "route"
      },
      ...
    ],
    "time": 1499192505285
  }
  ```
- `InviteAdded` / `{ id: glympse_invite_code, owner: glympse_user_account_id, card: card_id }`:
  Sent from the Glympse viewer whenever a Glympse invite has been successfully
  loaded and added to the map.
- `InviteClicked` / `{ id: glympse_invite_code, owner: glympse_user_account_id, card: card_id }`:
  Sent from the Glympse viewer whenever a Glympse invite has been clicked by the
  user (user icon or destination).
- `InviteError` / `GlympseInvite.js instance`: An error occurred while trying to
  load the Glympse Invite to retrieve invite data. Call the `getError()` API on the
  returned `GlympseInvite` instance to determine additional error state.
  - Note that in GA Host mode, GlympseInvite instances are not passed
- `InviteInit` / `glympse_invite_id`: Notification sent when a Glympse invite is to
  be loaded by the adapter to check for Card linkage. Note that is only seen during
  the initial start-up sequence of the adapter.
- `InviteReady` / `GlympseInvite.js instance`: Notification sent once a Glympse invite
  has been loaded. The `GlympseInvite.js` instance is a class that can be referenced
  for additional info on the status of the invite (i.e. if it was successfully loaded
  and has a Card reference). This is generally only needed by the adapter itself to
  determine if a card + additional Glympse invites need to be loaded. However, it will
  have possibly
  interesting information for the adapter host. Additional API information on the
  `GlympseInvite.js` class is found elsewhere in this documentation.
  - Note that in GA Host mode, GlympseInvite instances are not passed
- `InviteRemoved` / `{ id: glympse_invite_code, owner: glympse_user_account_id, card: card_id }`:
  Sent from the Glympse viewer whenever a Glympse invite has been removed from the map.
  No further updates will be seen from the Glympse invite via the adapter.
- `OauthError` / `{ id: glympse_invite_code, owner: glympse_user_account_id, ref: null, data: data }`:
  An error occurred when using a configuration-based authToken. No further attempts for the request will be made.
  Additional details can usually be found in the `data` payload.
- `Progress` / `{ curr: int, total: int }`: Seen during the initial loading phases of
  the adapter, and stops once the final `ViewerReady` message is generated.
- `StateUpdate` / `{ id: property_id, invite: glympse_invite_id, owner: glympse_account_id, card: card_id, t: timestamp, val: property_value }`:
  Updates generated when known properties are changed in the Glympse invite. Below is
  the list on known properties that can be seen via the `StateUpdate` message. These
  are enumerated in the `GlympseAdapterDefines.STATE` object
  - `Arrived`
  - `Avatar`
  - `Destination`
  - `Eta`
  - `Expired`
  - `InviteEnd`
  - `InviteStart`
  - `Message`
  - `Name`
  - `NoInvites` (seen if no Glympse invites are successfully loaded in the map)
  - `Phase`
- `UserNameUpdateStatus`: `{ status: bool, response: userData }`:
  - `status: true` - Indicates that user data has been changed, `response` includes new user's `name`
  - `status: false` - Error occurred, details in `response` property
- `UserAvatarUpdateStatus`: `{ status: bool, response: avatarObject }`:
  - `status: true` - Indicates that user avatar has been changed, `response` includes `url` to avatar
  - `status: false` - Error occurred, details in `response` property
- `UserInfoStatus`: `{ status: bool, response: userData }`:
  - `status: true` - Returns user's data
  - `status: false` - Error occurred, details in `response` property
- `ViewerInit` / `true`: Sent when the Glympse map viewer is beginning its
  initialization process, but is not yet ready.
- `ViewerReady` / `Glympse_viewer_instance`: Generated once the Glympse map control is
fully loaded and ready for presentation/interaction. The provided instance reference
allows for direct access to the Glympse viewer application API and all of its
components.
  - Note that in GA Host mode, Glympse Viewer instances are not passed
- `ViewerZoomChanged`: Generates once the Glympse map control's zoom is changed. Zoom value is passed as an argument.

## Message/Event flow

* params = card_invite, no glympse_invites

```
AdapterInit -> P -> CardsInitStart -> P -> CardInit -> P -> CardReady -> P -> CardsInitEnd -> P -> AdapterReady -> ViewerInit -> P -> ViewerReady -> P [Complete]
```

* params = no card_invite, glympse_invite (not tied to a card)

```
AdapterInit -> P -> InviteInit -> P -> InviteReady -> P -> AdapterReady -> ViewerInit -> P -> ViewerReady -> P [Complete]
```

* params = no card_invite, glympse_invite (tied to a card)

```
AdapterInit -> P -> InviteInit -> P -> InviteReady -> (move to card_invite/no glympse_invites flow)
```


## Adapter Endpoints
All relevent Glympse Viewer APIs are available for use with the GA. When running in
client-mode, all APIs are available, along with any instance variables that may be
passed along. In host-mode, the only Viewer APIs not available are ones relating to
DOM or global environment information, which cannot be reliably passed in an iframed
environment.

Endpoints are broken out on the following components:
  - `map`: Glympse Viewer endpoints accessiable via `adapter_instance.map.*`
  - `core`: Glympse Ticket endpoints accessiable via `adapter_instance.core.*`
  - `card`: Glympse Card endpoints accessiable via `adapter_instance.card.*`
  - `ext`: Custom client-app-included endpoints accessiable via `adapter_instance.ext.*`
  - `app`: Custom default-app endpoints accessiable via `adapter_instance.app.*`

### GlympseAdapter.map.* endpoints (host/client-mode):

Below is a list of all of the exposed GA APIs with respect to the Glympse Viewer API,
and available to either host or client-based consumers. These endpoints are also
specified in `GlympseAdapterDefines.MAP.REQUESTS`.

Access to these endpoints can be made via the `map` property of the adapter instance
(i.e.
`var eta = myAdapter.map.getInviteProperty({ idProperty: GlympseAdapterDefines.STATE.Eta })`).

- `getInviteProperies(idInvite)`: Returns all current properties for the given Glympse
  invite id. If `idInvite` is null/undefined, the first active Glympse's properties
  are returned. The returned object properties are defined in
  `GlympseAdapterDefines.STATE.*`.
- `getInviteProperty(cfgInvite)`: Returns the current property value of a Glympse
  invite. `cfgInvite` = `{ idProperty: name_of_property, idInvite: glympse_invite_id }`
  Note that `idInvite` can be null if the first/only tracked Glympse invite is desired.
  Available `idProperty` values are as follows (specified via
  `GlympseAdapterDefines.STATE.*` property names):
  - `Arrived`: Returns a boolean based on the active Glympse's arrival state
  - `Avatar`: String URL pointing to the Glympse sender's avatar image
  - `Destination`: Object describing current Glympse invite's destination
  - `Eta`: Current ETA (in seconds) of the Glympse sender (-1 if no destination is set)
  - `Expired`: Boolean idicating if the Glympse is still active
  - `InviteEnd`: Glympse invite end time (epoch time in ms)
  - `InviteStart`: Glympse invite start time (epoch time in ms)
  - `Message`: Message set for Glympse invite
  - `Name`: Glympse sender's username
  - `Phase`: Any relevent information related to an invite's phase property (usually
  just a string, if not null)
- `addInvites(invites)`: Accepts a semi-colon-delimited string of invites to display
  on the map. Additional configuration options are passed via comma-delimited strings,
  per Viewer API spec (found elsewhere).
- `addGroups(groups)`: Accepts a semi-colon-delimited string of Glympse group names
  to display on the map. Additional configuration options are passed via comma-
  delimited strings, per Viewer API spec (found elsewhere).
- `addMarkers(cfgMarkers)`: Adds a collection of static markers on the map, with
  several options. See below for more information on describing a marker.
- `addTwitterTopics(twitterTopics)`: Accepts a semi-colon-delimited string of Twitter
  topics (# names) to display on the map, using newer Glympse invite codes or the
  latest location found in topic tweets. Additional configuration options are passed
  via comma-delimited strings, per Viewer API spec (found elsewhere).
- `addTwitterUsers(twitterHandles)`: Accepts a semi-colon-delimited string of Twitter
  user names (@ names) to display on the map, using newer Glympse invite codes or the
  latest location found in the user's tweets. Additional configuration options are
  passed via comma-delimited strings, per Viewer API spec (found elsewhere).
- `refreshView()`: Force a viewer layout update. Useful when resizing static `div`
  containers used to host the Glympse Viewer.
- `removeInvites(invites)`: Comma-delimited string of Glympse invite codes to remove
  from the map.
- `setApiServices(url)`: Specifies the Glympse API environment URL to use
- `setPadding(padding)`: Used to offset the map "center" when determining map zoom
  based on active Glympses and destinations/POI. Effectively makes the centering
  view-port smaller than the map. The `padding` parameter is a 4-integer array,
  specifying [top, right, bottom, left] paddings (i.e. idential to CSS-style offset
  specifications).
- `updateSetting(val)`: Updates a viewer setting. Format =
  `{ id: setting_id, val: value_to_set }`. Only a few settings are accepted:
  - `attributionOffset`: Changes the vertical offset (from the bottom) of the map
  provider attribution. `val` = pixel offset from the bottom.
  - `zoomMax`: Sets max zoom level of the map for auto-zoom. `val` = Max integer zoom
  level.


### GlympseAdapter.map.* endpoints (client-mode-only):
The following APIs are only available to consumers of the GA when running in
client-mode. These are also specifed in `GlympseAdapterDefines.MAP.REQUESTS_LOCAL`:

- `generateRoute(cfgRoute)`: Adds a route path to the map, based on passed settings
  (see below for options). Returns a route object with the following API:
   - `run(callback)`: Initiates route load and adds it to the map
   - `setVisibility(bool)`: Show/hides route
   - `getLoaded()`: Current load status
   - `getVisibility()`: Current visibility status
- `getInvites()`: Returns an array of all GlympseInvite instances, as generated by the
  Glympse Viewer. The APIs available under a GlympseInvite will be discussed elsewhere
  in this document.
- `getMap()`: Returns a reference to the HERE map control used by the Glympse viewer.
  This reference is suitable for adding additional custom overlays in conjunction with
  the Glympse viewer's UI components. For more information, please refer to the
  [HERE Javascript APIs] documentation.
- `getMapContainer()`: Returns a reference to map container object used by the viewer.
  All map-related functionality is performed via this object. FIXME: need docs on it's APIs.
- `ignoreDestinations(bool)`: Hides current invite destinations. Returns a list of all
  affected destination objects.


### GlympseAdapter.core.* endpoints (host/client-mode):
Below is a list of all of the exposed GA APIs with respect to the core Glympse API,
and available to either host or client-based consumers. These endpoints are also
specified in `GlympseAdapterDefines.CORE.REQUESTS`.

- `addGroup(groupInfo: string|object)`: Creates a Glympse "public" group request for viewing.
  `groupInfo` can specify the group id to load (if it is a string type), or the response of
  an initial groups request (if it is an object type).
- `getEtaInfo(routes)`: Request the ETAs for specific routes. The routes format is
    ```
    [
        { 
            start: { lat: number, lng: number }, // start point of the route 
            waypoints: [{ lat: number, lng: number }, ...], // list of the route waypoints 
            end: { lat: number, lng: number }    // end point of the route
        },
        ...
    ]
    ```
  Results will be returned as `EtaInfo` event. The order of ETAs in results will be the same as in request agrs.
- `getGroups(null|groupId: string|[group_1,group_2,...]: Array)`: Returns a list of monitored
  Glympse public groups, based on the given input param (specified below). Returns an array
  of all matched groups, each containing current ticket invite and user information.
  - `null` | `undefined`: Returns the list of all tracked groups
  - `groupId`: String with a single group name
  - `[groupId0, groupId1, etc.]`: Array with a list of group names to retrieve
- `removeGroup(groupId: string, removeInvites: bool)`: Removes a monitored Glympse public group,
  with the option to also remove its active invites from the map, if the invites and the map
  itself exists. `removeInvites` defaults to false (invites are not automatically removed).
  Returns an object about the removal (see below). Some additional notes:
  - If the `removeInvites` param is true for a valid monitored group, additional events will be
    sent by the adapter as the invites are actually removed from the map.
  - The `removeGroup` API does nothing to the actual Glympse public group -- it only adjusts the
    local viewing experience.
  ```json
  {
    status: true|false,   // Removal status (i.e. the groupId was a monitored group)
    group: group_name,    // Name of the removed group
    invites: [            // List of active invites in the group
      "invite_id_0",
      "invite_id_1",
      ...
      "invite_id_N",
    ],
    removingInvites: true|false // Removal status of the group's invites
  }
  ```

- `getOrgObjects(params: Object)`: Requests a public group's `org` objects (public groups can
  specify an associated EnRoute org that can have an additional configuration in its objects).
  Supported request params:
  ```
  {
    orgId: target_org_id,  // [number] - id of the org to load objects for
    objType: object_type   // [string] - type of object to retrieve (null = all objects)
                                         [optional]
  }
  ```

### GlympseAdapter.core.* endpoints (client-mode-only):
The following APIs are only available to consumers of the GA when running in
client-mode. These are also specifed in `GlympseAdapterDefines.CORE.REQUESTS_LOCAL`:

- `accountCreate()`: Creates account, sends event `AccountCreateStatus` as a result.
- `accountDelete()`: Removes account, sends event `AccountDeleteStatus` as a result.
- `getUserInfo(userId: string)`: Gets info for the current logged in user (name, avatar URL, etc.).
 If the optional `userId` param is non-null, info is retrieved for the specified user instead.
- `hasAccount()`: Checks if the adapter has credentials for the currently configured API key.
 Synchronous method. Returns `false` for anonymous mode, or if no credentials are found.
- `setUserAvatar(imageUrlOrArrayBuffer: string|arraybuffer)`: Sets avatar to user, sends `UserAvatarUpdateStatus`
- `setUserName(name: string)`: Sets name to user, sends `UserAvatarUpdateStatus`
- `createRequest(rquest_params)`: Allow logged in user to generate a sharing request.
  ```
  request_params format:
  {
    type: string,     // Type of request -- email|sms|link|account|app ---> only accepts/uses "link" for now
    subtype: string,  // [OPTIONAL] Subtype of "app" types (50 char max) --> unused for now
    address: string,  // [OPTIONAL] Address of recipient for some types of requests (256 char max) --> unused for now
    name: string,     // [OPTIONAL] A friendly display name to be associated with the requestee. (150 char max)
    text: string,     // [OPTIONAL] Message to send --> unused for now
    send: string,     // [OPTIONAL] Values server|client --> unused for now
    locale: string,   // [OPTIONAL] Locale for localized resources --> unused for now
    brand: string,    // [OPTIONAL] Defines any sub-brand customization for the invite --> unused for now
  }
  ```


### GlympseAdapter.cards.* endpoints (host/client-mode):
Below is a list of all of the exposed GA APIs with respect to the Glympse Cards API,
and available to either host or client-based consumers. These endpoints are also
specified in `GlympseAdapterDefines.CARDS.REQUESTS`.

Access to these endpoints can be made via the `cards` property of the adapter instance
(i.e. `var val = myAdapter.cards.someMethod(some_val)`).

- `requestCards()`: Request cards for the current user. No return value - `CardAdded`/`CardRemoved` events will be generated.
- `joinRequest(requestConfig)`: [RequestConfig docs](https://developer.glympse.com/docs/core/api/reference/cards/requests/post#request), 
 Sends a request to join a card, sends `CardsJoinRequestStatus` with result of the API call
- `joinRequestCancel(requestId)`: Cancels a request to join a card, sends `CardsJoinRequestCancelStatus` with result of the API call
- `getActiveJoinRequests()`: Returns `CardsActiveJoinRequestsStatus` with the list of outstanding card join requests
- `removeMember(config)`: Removes a member from a given card. Sends `CardRemoveMemberStatus` with result of the API call.
  - `config.cardId`: Card id to remove a member
  - `config.memberId`: Member id of the member to remove. If no member_id is given, the current user is removed.
- `request(config)`: Sends location request to a card member or all card members. Sends `CardsLocationRequestStatus` with result of the API call.
  - `config.inviteCode`: Invite code generated by the app via `adapter.core.createRequest($request_params)`
  - `config.cardId`: Card id to send request
  - `config.memberList`: List of member_ids to send requests. Not used if scope = "all".
- `activity(config)`: Requests card's activities for the specified period ([read more](https://developer.glympse.com/docs/core/api/reference/cards/id/activity/get)). 
  Returns `CardActivityStatus` with the list of activities (Read more about this event [here](#adapter-messagesevents)).
  - `config.cardId`: Card id to request activities
  - `config.fromTS`: start timestamp
  - `config.toTS`: end timestamp


### GlympseAdapter.cards.* endpoints (client-mode-only):
The following APIs are only available to consumers of the GA when running in
client-mode. These are also specifed in `GlympseAdapterDefines.CARDS.REQUESTS_LOCAL`:

- `getCards()`: Returns currently loaded cards synchronously.


### GlympseAdapter.ext.* endpoints (host/client-mode):
Below is a list of all of the exposed GA APIs with respect to custom APIs generated by
the client-mode-based application that has integrated the GA. Generally, these APIs
will be available to either host or client-based consumers.

Access to these endpoints can be made via the `ext` property of the adapter instance
(i.e. `var val = myAdapter.ext.someCustomMethod(some_val)`).

- By default, no custom endpoints are provided by the GA


### GlympseAdapter.app.* endpoints (client-mode-only):
The following APIs are only available to consumers of the GA when running in
client-mode.

- `sendOasisMessage(id, val)`: Sends message to connected GA running in "host" mode 


### GlympseAdapter.app.* endpoints (host/client-mode):
Below is a list of all of the exposed GA APIs with respect to always available
app-based APIs. They generally pertain to the overall app configuration and structure:

- `getConfig()`: Returns the current `viewer` config object, along with the available
object/value under the `published` property of the main config used by the client.
Note that the `published` property is optional. Also, the `apiKey` value is removed
from the `viewer` config object if it is present.




## Available modules
The following AMD modules are available for use when building a module-based
application. While intended for using GA as a client-based module, there should be no
surprises even if running in host-mode.

- `glympse-adapter/GlympseAdapter`: Main module to initialize the Glympse adapter/
  viewer components. See test/app.js or test-glympse-app/Main.js for reference usage.
  This module is also addressable in the global namespace as:
  `window.glympse.GlympseAdapter`.
- `glympse-adapter/GlympseAdapterDefines`: Plain Javascript Object that contains the
  reference to all enums used by the GlympseAdapter. Strongly recommended to be used
  in conjunction with the GlympseAdapter module. This module is also addressable in
  the global namespace as: `window.glympse.GlympseAdapterDefines`.
- `glympse-adapter/VersionInfo`: Plain Javascript Object with build/version
  information of the GlympseAdapter.
- `glympse-adapter/lib/utils`: Static library containing utility functions useful
  for interacting with the GlympseAdapter module. _[TODO: list available methods]_
  
  
  
## Installation
The recommended method for using the GA component in a client-mode environment is
through a Bower installation of your require.js project. It is registered in the Bower
registry as `glympse-adapter` -- `bower install glympse-adapter --save`.

If you aren't using a require.js environment, or are planning to run the GA in host
mode, then you should use the latest pre-built version of the Adapter. Grab the
GlympseAdapter-CURRENT_VERSION.min.js file found in the `builds/` directory of this
repo. Usually, the highest version is the one to use.



## Glympse Adapter Roadmap
At this time, the primary utility of the GA is focussed largely on handling Glympse-
based invites and map views. As the Cards platform evolves, more features will be
provided on the cards.* endpoint for better messaging/full-duplex features and
support.

In addition to point and minor version maintenance updates, future versions of the GA
will include [Cordova] integration for interfacing with hybrid clients, where the
client "app" is the set of Cordova interfaces into a native implementation over a pure
Javascript solution.

The Cordova-aware version will also leverage the Glympse Cordova plug-in (if available
to the native app's webview) to provide better Glympse/Cards Platform integration, as
needed.



## Project Notes
This project leverages [oasis.js] and [rsvp.js] for hosting and communication
semantics. Unfortunately, due to each of their development approaches, a snapshot of
their transpiled Require.js-based sources must be included with this project to
properly use their functionality. For future maintenance, the latest commits used in
this snapshot are `4c657d15` and `5cfda622` of the `tildeio/oasis.js` and
`tildeio/rsvp.js` repos respectively.

**Important:** our copy contains few changes comparing to the original implementation:
- `sandbox.disabled` config param is added (for oasis/iframe_adapter.js#L84).
         It allows do not create actual "sandbox" env and therefore allows using all 
         features of iframed content w/o any restrictions (use with caution)

[HERE Javascript APIs]: https://developer.here.com/javascript-apis
[jQuery]: http://jquery.com
[Bower]: http://bower.io/
[RequireJS]: http://requirejs.org
[Promise/A+]: https://promisesaplus.com/
[Cordova]: http://cordova.apache.org/
[oasis.js]: https://github.com/tildeio/oasis.js
[rsvp.js]: https://github.com/tildeio/rsvp.js

## Release a new version
- Version information updates:
  - `Gruntfile.js`: `data.config.moduleVersion` with the new [semantic] (MAJOR.MINOR.PATCH) version
  - `bower.json`: `version` property (same value as used above)
  - `package.json`: `version` property (same value as used above)
- This `README.md` with any relevent changes
- `CHANGELOG.md` should be updated with high-level change info
- `grunt` should return no warnings or errors
  - Note that `grunt` will also generate a compiled version of the GJC component, located in the root `builds/` directory
- check in to `develop` branch with message that confirms this was a new release: 'build x.x.x'
- switch to `master` branch and merge `develop` branch to `master` branch (don't forget to push the code)
- generate a new release with github: Open project > Releases tab > Draft a new message. 
Then put a new version number, select `master` branch and press "Publish release". This will also automatically create a tag.
